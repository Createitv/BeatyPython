## 1. çº¿ç¨‹ä»‹ç»

ç›®å‰ï¼Œåœ¨è½¯ä»¶åº”ç”¨ä¸­ä½¿ç”¨æœ€å¹¿æ³›çš„å¹¶å‘ç¼–ç¨‹èŒƒä¾‹æ˜¯å¤šçº¿ç¨‹ã€‚é€šå¸¸ï¼Œä¸€ä¸ªåº”ç”¨æœ‰ä¸€ä¸ªè¿›ç¨‹ï¼Œåˆ†æˆå¤šä¸ªç‹¬ç«‹çš„çº¿ç¨‹ï¼Œå¹¶è¡Œè¿è¡Œã€äº’ç›¸é…åˆï¼Œæ‰§è¡Œä¸åŒç±»å‹çš„ä»»åŠ¡ã€‚

ä¸»è¦ç‰¹ç‚¹ï¼š

- çº¿ç¨‹æ˜¯ç‹¬ç«‹çš„å¤„ç†æµç¨‹ï¼Œå¯ä»¥å’Œç³»ç»Ÿçš„å…¶ä»–çº¿ç¨‹å¹¶è¡Œæˆ–å¹¶å‘åœ°æ‰§è¡Œã€‚
- å¤šçº¿ç¨‹å¯ä»¥å…±äº«æ•°æ®å’Œèµ„æºï¼Œåˆ©ç”¨æ‰€è°“çš„å…±äº«å†…å­˜ç©ºé—´ã€‚
- åŒä¸€è¿›ç¨‹çš„å¤šä¸ªä¸åŒçš„çº¿ç¨‹å¯ä»¥å…±äº«ç›¸åŒçš„èµ„æºã€‚ç›¸æ¯”è€Œè¨€ï¼Œè¿›ç¨‹ä¹‹é—´ä¸ä¼šå…±äº«èµ„æºã€‚

æ¯ä¸€ä¸ªçº¿ç¨‹åŸºæœ¬ä¸ŠåŒ…å«3ä¸ªå…ƒç´ ï¼šç¨‹åºè®¡æ•°å™¨ï¼Œå¯„å­˜å™¨å’Œæ ˆã€‚ä¸åŒä¸€è¿›ç¨‹çš„å…¶ä»–çº¿ç¨‹å…±äº«çš„èµ„æºåŸºæœ¬ä¸ŠåŒ…æ‹¬æ•°æ®å’Œç³»ç»Ÿèµ„æºã€‚æ¯ä¸€ä¸ªçº¿ç¨‹ä¹Ÿæœ‰è‡ªå·±çš„è¿è¡ŒçŠ¶æ€ï¼Œå¯ä»¥å’Œå…¶ä»–çº¿ç¨‹åŒæ­¥ï¼Œè¿™ç‚¹å’Œè¿›ç¨‹ä¸€æ ·ã€‚çº¿ç¨‹çš„çŠ¶æ€å¤§ä½“ä¸Šå¯ä»¥åˆ†ä¸º**ready**,**running**,**blocked**ã€‚

## 2. pythonçº¿ç¨‹æ¨¡å—ä»‹ç»

Pythoné€šè¿‡æ ‡å‡†åº“çš„ `threading` æ¨¡å—æ¥ç®¡ç†çº¿ç¨‹ã€‚è¿™ä¸ªæ¨¡å—æä¾›äº†å¾ˆå¤šä¸é”™çš„ç‰¹æ€§ï¼Œè®©çº¿ç¨‹å˜å¾—æ— æ¯”ç®€å•ã€‚å®é™…ä¸Šï¼Œçº¿ç¨‹æ¨¡å—æä¾›äº†å‡ ç§åŒæ—¶è¿è¡Œçš„æœºåˆ¶ï¼Œå®ç°èµ·æ¥éå¸¸ç®€å•ã€‚

çº¿ç¨‹æ¨¡å—çš„ä¸»è¦ç»„ä»¶å¦‚ä¸‹ï¼š

- çº¿ç¨‹å¯¹è±¡
- Lockå¯¹è±¡
- RLockå¯¹è±¡
- ä¿¡å·å¯¹è±¡
- æ¡ä»¶å¯¹è±¡
- äº‹ä»¶å¯¹è±¡

## 3. å®šä¹‰ä¸€ä¸ªpythonçº¿ç¨‹

ä½¿ç”¨çº¿ç¨‹æœ€ç®€å•çš„ä¸€ä¸ªæ–¹æ³•æ˜¯ï¼Œç”¨ä¸€ä¸ªç›®æ ‡å‡½æ•°å®ä¾‹åŒ–ä¸€ä¸ªThreadç„¶åè°ƒç”¨ `start()` æ–¹æ³•å¯åŠ¨å®ƒã€‚Pythonçš„threadingæ¨¡å—æä¾›äº† `Thread()` æ–¹æ³•åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­è¿è¡Œå‡½æ•°æˆ–å¤„ç†è¿‡ç¨‹ç­‰ã€‚

```python
class threading.Thread(group=None,
                       target=None,
                       name=None,
                       args=(),
                       kwargs={})
```

ä¸Šé¢çš„ä»£ç ä¸­ï¼š

- `group`: ä¸€èˆ¬è®¾ç½®ä¸º `None` ï¼Œè¿™æ˜¯ä¸ºä»¥åçš„ä¸€äº›ç‰¹æ€§é¢„ç•™çš„
- `target`: å½“çº¿ç¨‹å¯åŠ¨çš„æ—¶å€™è¦æ‰§è¡Œçš„å‡½æ•°
- `name`: çº¿ç¨‹çš„åå­—ï¼Œé»˜è®¤ä¼šåˆ†é…ä¸€ä¸ªå”¯ä¸€åå­— `Thread-N`
- `args`: ä¼ é€’ç»™ `target` çš„å‚æ•°ï¼Œè¦ä½¿ç”¨tupleç±»å‹
- `kwargs`: åŒä¸Šï¼Œä½¿ç”¨å­—å…¸ç±»å‹dict

åˆ›å»ºçº¿ç¨‹çš„æ–¹æ³•éå¸¸å®ç”¨ï¼Œé€šè¿‡`target`å‚æ•°`arg`å’Œ`kwarg`å‘Šè¯‰çº¿ç¨‹åº”è¯¥åšä»€ä¹ˆã€‚ä¸‹é¢è¿™ä¸ªä¾‹å­ä¼ é€’ä¸€ä¸ªæ•°å­—ç»™çº¿ç¨‹ï¼ˆè¿™ä¸ªæ•°å­—æ­£å¥½ç­‰äºçº¿ç¨‹å·ç ï¼‰ï¼Œç›®æ ‡å‡½æ•°ä¼šæ‰“å°å‡ºè¿™ä¸ªæ•°å­—ã€‚

### 3.1 ä»£ç ä¸¾ä¾‹

```python
import threading

def function(i):
    print ("function called by thread %i\n" % i)
    return

threads = []

for i in range(5):
  	# çº¿ç¨‹å¯¹è±¡
    t = threading.Thread(target=function , args=(i, ))
    threads.append(t)
    t.start()
    # åŠ å…¥ä¸»çº¿ç¨‹é˜Ÿåˆ—
    t.join()
```

è¾“å‡º

```python
 âœ”  python -u thread_simple.py
function called by thread 0

function called by thread 1

function called by thread 2

function called by thread 3

function called by thread 4
```

å¯¼å…¥å†…ç½®threadingæ¨¡å—ï¼Œç®€å•åœ°ä½¿ç”¨pythonå‘½ä»¤å°±å¯ä»¥äº†ï¼š

```
import threading
```

åœ¨ä¸»ç¨‹åºä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ç›®æ ‡å‡½æ•° `function` åˆå§‹åŒ–äº†ä¸€ä¸ªçº¿ç¨‹å¯¹è±¡ `Thread` ã€‚åŒæ—¶è¿˜ä¼ å…¥äº†ç”¨äºæ‰“å°çš„ä¸€ä¸ªå‚æ•°ï¼š

```
t = threading.Thread(target=function , args=(i, ))
```

çº¿ç¨‹è¢«åˆ›å»ºä¹‹åå¹¶ä¸ä¼šé©¬ä¸Šè¿è¡Œï¼Œéœ€è¦æ‰‹åŠ¨è°ƒç”¨ `start()` ï¼Œ `join()` è®©è°ƒç”¨å®ƒçš„çº¿ç¨‹ä¸€ç›´ç­‰å¾…ç›´åˆ°æ‰§è¡Œç»“æŸï¼ˆå³é˜»å¡è°ƒç”¨å®ƒçš„ä¸»çº¿ç¨‹ï¼Œ `t` çº¿ç¨‹æ‰§è¡Œç»“æŸï¼Œä¸»çº¿ç¨‹æ‰ä¼šç»§ç»­æ‰§è¡Œï¼‰ï¼š

```
t.start()
t.join()
```

## 4. ç¡®å®šçº¿ç¨‹è¿è¡ŒçŠ¶æ€

threadingæ¨¡å—æä¾›äº†ä¸€äº›æ¯”è¾ƒå®ç”¨çš„æ–¹æ³•æˆ–è€…å±æ€§

![image-20210624092547213](https://typora-1300715298.cos.ap-shanghai.myqcloud.com/uPic/image-20210624092547213.png)

```python
import urllib.request
import threading
import logging
import os

logging.basicConfig(level=logging.DEBUG,
                    format='%(asctime)s-%(levelname)s-%(message)s')
logger = logging.getLogger(__name__)
sites = [
    '<https://www.yahoo.com/>',
    '<http://www.cnn.com>',
    '<http://www.python.org>',
    '<http://www.jython.org>',
    '<http://www.pypy.org>',
    '<http://www.perl.org>',
    '<http://www.cisco.com>',
    '<http://www.facebook.com>',
    '<http://www.twitter.com>',
    "<https://www.youtube.com/>",
    '<http://arstechnica.com/>',
    '<http://www.reuters.com/>',
    '<http://abcnews.go.com/>',
    '<http://www.cnbc.com/>',
]

def getHtml(url):
    page = urllib.request.urlopen(url).read()
    print(url, len(page))

for url in sites:
    threading.Thread(target=getHtml, args=(url,)).start()
logger.info(f'Process ID: {os.getpid()}')
logger.info(f"Main thread {threading.main_thread()}")
logger.info(f'Thread Count: {threading.active_count()}')
for thread in threading.enumerate():
    logger.info(thread)
```

è¿è¡Œç»“æœï¼š

![image-20210624092630425](https://typora-1300715298.cos.ap-shanghai.myqcloud.com/uPic/image-20210624092630425.png)

### ç»™çº¿ç¨‹å‘½å

ä½¿ç”¨å‚æ•°æ¥ç¡®è®¤æˆ–å‘½åçº¿ç¨‹æ˜¯ç¬¨æ‹™ä¸”æ²¡æœ‰å¿…è¦çš„ã€‚æ¯ä¸€ä¸ª `Thread` å®ä¾‹åˆ›å»ºçš„æ—¶å€™éƒ½æœ‰ä¸€ä¸ªå¸¦é»˜è®¤å€¼çš„åå­—ï¼Œå¹¶ä¸”å¯ä»¥ä¿®æ”¹ã€‚åœ¨æœåŠ¡ç«¯é€šå¸¸ä¸€ä¸ªæœåŠ¡è¿›ç¨‹éƒ½æœ‰å¤šä¸ªçº¿ç¨‹æœåŠ¡ï¼Œè´Ÿè´£ä¸åŒçš„æ“ä½œï¼Œè¿™æ—¶å€™å‘½åçº¿ç¨‹æ˜¯å¾ˆå®ç”¨çš„

```python
import threading
import time

def first_function():
    print(threading.currentThread().getName() + str(' is Starting '))
    time.sleep(2)
    print (threading.currentThread().getName() + str(' is Exiting '))
    return

def second_function():
    print(threading.currentThread().getName() + str(' is Starting '))
    time.sleep(2)
    print (threading.currentThread().getName() + str(' is Exiting '))
    return

def third_function():
    print(threading.currentThread().getName() + str(' is Starting '))
    time.sleep(2)
    print(threading.currentThread().getName() + str(' is Exiting '))
    return

if __name__ == "__main__":
    t1 = threading.Thread(name='first_function', target=first_function)
    t2 = threading.Thread(name='second_function', target=second_function)
    t3 = threading.Thread(name='third_function', target=third_function)
    t1.start()
    t2.start()
    t3.start()
```

è¿è¡Œç»“æœ:

```python
 âœ”  python -u thread_simple.py
first_function is Starting 
second_function is Starting 
third_function is Starting 
first_function is Exiting 
second_function is Exiting 
third_function is Exiting 
```

### è§£æ

æˆ‘ä»¬ä½¿ç”¨ç›®æ ‡å‡½æ•°å®ä¾‹åŒ–çº¿ç¨‹ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¼ å…¥ `name` å‚æ•°ä½œä¸ºçº¿ç¨‹çš„åå­—ï¼Œå¦‚æœä¸ä¼ è¿™ä¸ªå‚æ•°ï¼Œå°†ä½¿ç”¨é»˜è®¤çš„å‚æ•°ï¼š

```
t1 = threading.Thread(name='first_function', target=first_function)
t2 = threading.Thread(name='second_function', target=second_function)
t3 = threading.Thread(target=third_function)
```

ï¼ˆè¯‘è€…æ³¨ï¼šè¿™é‡Œçš„ä»£ç å’Œä¸Šé¢çš„ä¸ä¸€æ ·ï¼Œå¯èƒ½ä½œè€…æœ¬æ„æ˜¯ç¬¬ä¸‰ä¸ªçº¿ç¨‹ä¸åŠ å‚æ•°æ¥æµ‹è¯•é»˜è®¤çš„è¡Œä¸ºï¼Œå¦‚æœæ”¹ä¸ºè¿™é‡Œçš„ä»£ç ï¼Œé‚£ä¹ˆçº¿ç¨‹3å°†ä¼šè¾“å‡ºçš„æ˜¯ `Thread-1 is Starting` ä»¥åŠ `Thread-1 is Exiting` ï¼Œè¯»è€…å¯ä»¥è‡ªè¡Œå°è¯•ï¼‰

æœ€åè°ƒç”¨ `start()` å’Œ `join()` å¯åŠ¨å®ƒä»¬ã€‚

```
t1.start()
t2.start()
t3.start()
t1.join()
t2.join()
t3.join()
```

## 5. è‡ªå·±åŠ¨æ‰‹å®ç°ä¸€ä¸ªçº¿ç¨‹

ä½¿ç”¨threadingæ¨¡å—å®ç°ä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œéœ€è¦ä¸‹é¢3æ­¥ï¼š

- å®šä¹‰ä¸€ä¸ª `Thread` ç±»çš„å­ç±»
- é‡å†™ `__init__(self [,args])` æ–¹æ³•ï¼Œå¯ä»¥æ·»åŠ é¢å¤–çš„å‚æ•°
- æœ€åï¼Œéœ€è¦é‡å†™ `run(self, [,args])` æ–¹æ³•æ¥å®ç°çº¿ç¨‹è¦åšçš„äº‹æƒ…

å½“ä½ åˆ›å»ºäº†æ–°çš„ `Thread` å­ç±»çš„æ—¶å€™ï¼Œä½ å¯ä»¥å®ä¾‹åŒ–è¿™ä¸ªç±»ï¼Œè°ƒç”¨ `start()` æ–¹æ³•æ¥å¯åŠ¨å®ƒã€‚çº¿ç¨‹å¯åŠ¨ä¹‹åå°†ä¼šæ‰§è¡Œ `run()` æ–¹æ³•ã€‚

```python
import threading
import time

exitFlag = 0

class myThread (threading.Thread):
    def __init__(self, threadID, name, counter):
        threading.Thread.__init__(self)
        self.threadID = threadID
        self.name = name
        self.counter = counter

    def run(self):
        print("Starting " + self.name)
        print_time(self.name, self.counter, 5)
        print("Exiting " + self.name)

def print_time(threadName, delay, counter):
    while counter:
        if exitFlag:
            # è¯‘è€…æ³¨ï¼šåŸä¹¦ä¸­ä½¿ç”¨çš„threadï¼Œä½†æ˜¯Python3ä¸­å·²ç»ä¸èƒ½ä½¿ç”¨threadï¼Œä»¥_threadå–ä»£ï¼Œå› æ­¤åº”è¯¥
            # import _thread
            # _thread.exit()
            thread.exit()
        time.sleep(delay)
        print("%s: %s" % (threadName, time.ctime(time.time())))
        counter -= 1

# Create new threads
thread1 = myThread(1, "Thread-1", 1)
thread2 = myThread(2, "Thread-2", 2)

# Start new Threads
thread1.start()
thread2.start()

# ä»¥ä¸‹ä¸¤è¡Œä¸ºè¯‘è€…æ·»åŠ ï¼Œå¦‚æœè¦è·å¾—å’Œå›¾ç‰‡ç›¸åŒçš„ç»“æœï¼Œ
# ä¸‹é¢ä¸¤è¡Œæ˜¯å¿…é¡»çš„ã€‚ç–‘ä¼¼åŸä½œè€…çš„ç–æ¼
thread1.join()
thread2.join()
print("Exiting Main Thread")
```

ç»“æœï¼š

```python
 âœ”  python -u thread_run.py
Starting Thread-1Starting Thread-2

Thread-1: Thu Jun 24 09:31:43 2021
Thread-2: Thu Jun 24 09:31:44 2021Thread-1: Thu Jun 24 09:31:44 2021

Thread-1: Thu Jun 24 09:31:45 2021
Thread-1: Thu Jun 24 09:31:46 2021Thread-2: Thu Jun 24 09:31:46 2021

Thread-1: Thu Jun 24 09:31:47 2021
Exiting Thread-1
Thread-2: Thu Jun 24 09:31:48 2021
Thread-2: Thu Jun 24 09:31:50 2021
Thread-2: Thu Jun 24 09:31:52 2021
Exiting Thread-2
Exiting Main Thread
```

è§£é‡Šï¼š

`threading` æ¨¡å—æ˜¯åˆ›å»ºå’Œç®¡ç†çº¿ç¨‹çš„é¦–é€‰å½¢å¼ã€‚æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½é€šè¿‡ä¸€ä¸ªç»§æ‰¿ `Thread` ç±»ï¼Œé‡å†™ `run()` æ–¹æ³•æ¥å®ç°é€»è¾‘ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯çº¿ç¨‹çš„å…¥å£ã€‚åœ¨ä¸»ç¨‹åºä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†å¤šä¸ª `myThread` çš„ç±»å‹å®ä¾‹ï¼Œç„¶åæ‰§è¡Œ `start()` æ–¹æ³•å¯åŠ¨å®ƒä»¬ã€‚è°ƒç”¨ `Thread.__init__` æ„é€ å™¨æ–¹æ³•æ˜¯å¿…é¡»çš„ï¼Œé€šè¿‡å®ƒæˆ‘ä»¬å¯ä»¥ç»™çº¿ç¨‹å®šä¹‰ä¸€äº›åå­—æˆ–åˆ†ç»„ä¹‹ç±»çš„å±æ€§ã€‚è°ƒç”¨ `start()` ä¹‹åçº¿ç¨‹å˜ä¸ºæ´»è·ƒçŠ¶æ€ï¼Œå¹¶ä¸”æŒç»­ç›´åˆ° `run()` ç»“æŸï¼Œæˆ–è€…ä¸­é—´å‡ºç°å¼‚å¸¸ã€‚æ‰€æœ‰çš„çº¿ç¨‹éƒ½æ‰§è¡Œå®Œæˆä¹‹åï¼Œç¨‹åºç»“æŸã€‚

`join()` å‘½ä»¤æ§åˆ¶ä¸»çº¿ç¨‹çš„ç»ˆæ­¢ã€‚

## 6. çº¿ç¨‹é”ğŸ”’

å½“ä¸¤ä¸ªæˆ–ä»¥ä¸Šå¯¹å…±äº«å†…å­˜çš„æ“ä½œå‘ç”Ÿåœ¨å¹¶å‘çº¿ç¨‹ä¸­ï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªå¯ä»¥æ”¹å˜æ•°æ®ï¼Œåˆæ²¡æœ‰åŒæ­¥æœºåˆ¶çš„æ¡ä»¶ä¸‹ï¼Œå°±ä¼šäº§ç”Ÿç«äº‰æ¡ä»¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ‰§è¡Œæ— æ•ˆä»£ç ã€bugã€æˆ–å¼‚å¸¸è¡Œä¸ºã€‚

ç«äº‰æ¡ä»¶æœ€ç®€å•çš„è§£å†³æ–¹æ³•æ˜¯ä½¿ç”¨é”ã€‚é”çš„æ“ä½œéå¸¸ç®€å•ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹éœ€è¦è®¿é—®éƒ¨åˆ†å…±äº«å†…å­˜æ—¶ï¼Œå®ƒå¿…é¡»å…ˆè·å¾—é”æ‰èƒ½è®¿é—®ã€‚æ­¤çº¿ç¨‹å¯¹è¿™éƒ¨åˆ†å…±äº«èµ„æºä½¿ç”¨å®Œæˆä¹‹åï¼Œè¯¥çº¿ç¨‹å¿…é¡»é‡Šæ”¾é”ï¼Œç„¶åå…¶ä»–çº¿ç¨‹å°±å¯ä»¥æ‹¿åˆ°è¿™ä¸ªé”å¹¶è®¿é—®è¿™éƒ¨åˆ†èµ„æºäº†ã€‚

ç„¶è€Œï¼Œåœ¨å®é™…ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å‘ç°è¿™ä¸ªæ–¹æ³•ç»å¸¸ä¼šå¯¼è‡´ä¸€ç§ç³Ÿç³•çš„æ­»é”ç°è±¡ã€‚å½“ä¸åŒçš„çº¿ç¨‹è¦æ±‚å¾—åˆ°ä¸€ä¸ªé”æ—¶ï¼Œæ­»é”å°±ä¼šå‘ç”Ÿï¼Œè¿™æ—¶ç¨‹åºä¸å¯èƒ½ç»§ç»­æ‰§è¡Œï¼Œå› ä¸ºå®ƒä»¬äº’ç›¸æ‹¿ç€å¯¹æ–¹éœ€è¦çš„é”ã€‚ä½¿ç”¨é”æ¥è§£å†³åŒæ­¥é—®é¢˜æ˜¯ä¸€ä¸ªå¯è¡Œå´å­˜åœ¨æ½œåœ¨é—®é¢˜çš„æ–¹æ¡ˆã€‚

### 6.1 ä»£ç è§£é‡Š

```python
# -*- coding: utf-8 -*-

import threading

shared_resource_with_lock = 0
shared_resource_with_no_lock = 0
COUNT = 100000
shared_resource_lock = threading.Lock()

# æœ‰é”çš„æƒ…å†µ
def increment_with_lock():
    global shared_resource_with_lock
    for i in range(COUNT):
        shared_resource_lock.acquire()
        shared_resource_with_lock += 1
        shared_resource_lock.release()

def decrement_with_lock():
    global shared_resource_with_lock
    for i in range(COUNT):
        shared_resource_lock.acquire()
        shared_resource_with_lock -= 1
        shared_resource_lock.release()

# æ²¡æœ‰é”çš„æƒ…å†µ
def increment_without_lock():
    global shared_resource_with_no_lock
    for i in range(COUNT):
        shared_resource_with_no_lock += 1

def decrement_without_lock():
    global shared_resource_with_no_lock
    for i in range(COUNT):
        shared_resource_with_no_lock -= 1

if __name__ == "__main__":
    t1 = threading.Thread(target=increment_with_lock)
    t2 = threading.Thread(target=decrement_with_lock)
    t3 = threading.Thread(target=increment_without_lock)
    t4 = threading.Thread(target=decrement_without_lock)
    t1.start()
    t2.start()
    t3.start()
    t4.start()
    t1.join()
    t2.join()
    t3.join()
    t4.join()
    print ("the value of shared variable with lock management is %s" % shared_resource_with_lock)
    print ("the value of shared variable with race condition is %s" % shared_resource_with_no_lock)
```

è¿è¡Œç»“æœï¼š

```python
 âœ”  python -u thread_lock.py
the value of shared variable with lock management is 0
the value of shared variable with race condition is 67058
```

å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœæœ‰é”æ¥ç®¡ç†çº¿ç¨‹çš„è¯ï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°æ­£ç¡®çš„ç»“æœã€‚è¿™é‡Œè¦æ³¨æ„ï¼Œæ²¡æœ‰é”çš„æƒ…å†µä¸‹å¹¶ä¸ä¸€å®šä¼šå¾—åˆ°é”™è¯¯çš„ç»“æœï¼Œä½†æ˜¯é‡å¤æ‰§è¡Œå¤šæ¬¡ï¼Œæ€»ä¼šå‡ºç°é”™è¯¯çš„ç»“æœã€‚è€Œæœ‰é”çš„æƒ…å†µç»“æœæ€»ä¼šæ˜¯æ­£ç¡®çš„ã€‚

### 6.2 ä»£ç è§£é‡Š

åœ¨ä¸»ç¨‹åºä¸­ï¼Œæˆ‘ä»¬æœ‰ä»¥ä¸‹æ­¥éª¤ï¼š

```
t1 = threading.Thread(target=increment_with_lock)
t2 = threading.Thread(target=decrement_with_lock)
```

å¯åŠ¨çº¿ç¨‹ï¼š

```
t1.start()
t2.start()
```

ç„¶åé˜»å¡ä¸»çº¿ç¨‹ç›´åˆ°æ‰€æœ‰çº¿ç¨‹å®Œæˆï¼š

```
t1.join()
t2.join()
```

åœ¨ `increment_with_lock()` å‡½æ•°å’Œ `decrement_with_lock()` å‡½æ•°ä¸­ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä½¿ç”¨äº†lockè¯­å¥ã€‚å½“ä½ éœ€è¦ä½¿ç”¨èµ„æºçš„æ—¶å€™ï¼Œè°ƒç”¨ `acquire()` æ‹¿åˆ°é”ï¼ˆå¦‚æœé”æš‚æ—¶ä¸å¯ç”¨ï¼Œä¼šä¸€ç›´ç­‰å¾…ç›´åˆ°æ‹¿åˆ°ï¼‰ï¼Œæœ€åè°ƒç”¨ `release()`:

```
shared_resource_lock.acquire()
shared_resource_with_lock -= 1
shared_resource_lock.release()
```

è®©æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ï¼š

- é”æœ‰ä¸¤ç§çŠ¶æ€ï¼š lockedï¼ˆè¢«æŸä¸€çº¿ç¨‹æ‹¿åˆ°ï¼‰å’Œunlockedï¼ˆå¯ç”¨çŠ¶æ€ï¼‰
- æˆ‘ä»¬æœ‰ä¸¤ä¸ªæ–¹æ³•æ¥æ“ä½œé”ï¼š `acquire()` å’Œ `release()`

éœ€è¦éµå¾ªä»¥ä¸‹è§„åˆ™ï¼š

- å¦‚æœçŠ¶æ€æ˜¯unlockedï¼Œ å¯ä»¥è°ƒç”¨ `acquire()` å°†çŠ¶æ€æ”¹ä¸ºlocked
- å¦‚æœçŠ¶æ€æ˜¯lockedï¼Œ `acquire()` ä¼šè¢«blockç›´åˆ°å¦ä¸€çº¿ç¨‹è°ƒç”¨ `release()` é‡Šæ”¾é”
- å¦‚æœçŠ¶æ€æ˜¯unlockedï¼Œ è°ƒç”¨ `release()` å°†å¯¼è‡´ `RuntimError` å¼‚å¸¸
- å¦‚æœçŠ¶æ€æ˜¯lockedï¼Œ å¯ä»¥è°ƒç”¨ `release()` å°†çŠ¶æ€æ”¹ä¸ºunlocked

### 6.3. çº¿ç¨‹å¼Šç«¯

å°½ç®¡ç†è®ºä¸Šè¡Œå¾—é€šï¼Œä½†æ˜¯é”çš„ç­–ç•¥ä¸ä»…ä¼šå¯¼è‡´æœ‰å®³çš„åƒµæŒå±€é¢ã€‚è¿˜ä¼šå¯¹åº”ç”¨ç¨‹åºçš„å…¶ä»–æ–¹é¢äº§ç”Ÿè´Ÿé¢å½±å“ã€‚è¿™æ˜¯ä¸€ç§ä¿å®ˆçš„æ–¹æ³•ï¼Œç»å¸¸ä¼šå¼•èµ·ä¸å¿…è¦çš„å¼€é”€ï¼Œä¹Ÿä¼šé™åˆ¶ç¨‹åºçš„å¯æ‰©å±•æ€§å’Œå¯è¯»æ€§ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œæœ‰æ—¶å€™éœ€è¦å¯¹å¤šè¿›ç¨‹å…±äº«çš„å†…å­˜åˆ†é…ä¼˜å…ˆçº§ï¼Œä½¿ç”¨é”å¯èƒ½å’Œè¿™ç§ä¼˜å…ˆçº§å†²çªã€‚æœ€åï¼Œä»å®è·µçš„ç»éªŒæ¥çœ‹ï¼Œä½¿ç”¨é”çš„åº”ç”¨å°†å¯¹debugå¸¦æ¥ä¸å°çš„éº»çƒ¦ã€‚æ‰€ä»¥ï¼Œæœ€å¥½ä½¿ç”¨å…¶ä»–å¯é€‰çš„æ–¹æ³•ç¡®ä¿åŒæ­¥è¯»å–å…±äº«å†…å­˜ï¼Œé¿å…ç«äº‰æ¡ä»¶ã€‚

## 7. é€’å½’é”RLOCK

RLockå…¶å®å«åšâ€œReentrant Lockâ€ï¼Œå°±æ˜¯å¯ä»¥é‡å¤è¿›å…¥çš„é”ï¼Œä¹Ÿå«åšâ€œé€’å½’é”â€ã€‚è¿™ç§é”å¯¹æ¯”Lockæœ‰æ˜¯ä¸‰ä¸ªç‰¹ç‚¹ï¼š1. è°æ‹¿åˆ°è°é‡Šæ”¾ã€‚å¦‚æœçº¿ç¨‹Aæ‹¿åˆ°é”ï¼Œçº¿ç¨‹Bæ— æ³•é‡Šæ”¾è¿™ä¸ªé”ï¼Œåªæœ‰Aå¯ä»¥é‡Šæ”¾ï¼›2. åŒä¸€çº¿ç¨‹å¯ä»¥å¤šæ¬¡æ‹¿åˆ°è¯¥é”ï¼Œå³å¯ä»¥acquireå¤šæ¬¡ï¼›3. acquireå¤šå°‘æ¬¡å°±å¿…é¡»releaseå¤šå°‘æ¬¡ï¼Œåªæœ‰æœ€åä¸€æ¬¡releaseæ‰èƒ½æ”¹å˜RLockçš„çŠ¶æ€ä¸ºunlocked

å¦‚æœæ˜¯ä¸€æŠŠäº’æ–¥é”ï¼ˆthreading.Lock()ï¼‰ï¼Œé‚£ä¹ˆä¸‹é¢çš„ä»£ç ä¼šå‘ç”Ÿå µå¡ï¼š

```python
import threading
lock = threading.Lock()

lock.acquire()
    for i in range(10):
        print('è·å–ç¬¬äºŒæŠŠé”')
        lock.acquire()
        print(f'test.......{i}')
        lock.release()
    lock.release()

```

åŒæ ·çš„ä»£ç ï¼Œå¦‚æœæ¢æˆï¼ˆthreading.RLock()ï¼‰ï¼Œåˆ™ä¸ä¼šå‘ç”Ÿå µå¡ï¼š

```python
import threading
lock = threading.RLock()

lock.acquire()
    for i in range(10):
        print('è·å–ç¬¬äºŒæŠŠé”')
        lock.acquire()
        print(f'test.......{i}')
        lock.release()
    lock.release()
```

**RLockå…¶å®åº•å±‚ç»´æŠ¤äº†ä¸€ä¸ªäº’æ–¥é”å’Œä¸€ä¸ªè®¡æ•°å™¨**

## 8. ä¿¡å·é‡

**ä¿¡å·é‡ä¹Ÿæ˜¯ä¸€æŠŠé”ï¼Œç”¨æ¥æ§åˆ¶çº¿ç¨‹å¹¶å‘æ•°çš„**ã€‚BoundedSemaphoreæˆ–Semaphoreç®¡ç†ä¸€ä¸ªå†…ç½®çš„è®¡æ•° å™¨ï¼Œæ¯å½“è°ƒç”¨acquire()æ—¶-1ï¼Œè°ƒç”¨release()æ—¶+1ã€‚

è®¡æ•°å™¨ä¸èƒ½å°äº0ï¼Œå½“è®¡æ•°å™¨ä¸º 0æ—¶ï¼Œacquire()å°†é˜»å¡çº¿ç¨‹è‡³åŒæ­¥é”å®šçŠ¶æ€ï¼Œç›´åˆ°å…¶ä»–çº¿ç¨‹è°ƒç”¨release()ã€‚(ç±»ä¼¼äºåœè½¦ä½çš„æ¦‚å¿µ)

ç±»åï¼šBoundedSemaphoreã€‚è¿™ç§é”å…è®¸ä¸€å®šæ•°é‡çš„çº¿ç¨‹åŒæ—¶æ›´æ”¹æ•°æ®ï¼Œå®ƒä¸æ˜¯äº’æ–¥é”ã€‚æ¯”å¦‚åœ°é“å®‰æ£€ï¼Œæ’é˜Ÿäººå¾ˆå¤šï¼Œå·¥ä½œäººå‘˜åªå…è®¸ä¸€å®šæ•°é‡çš„äººè¿›å…¥å®‰æ£€åŒºï¼Œå…¶å®ƒçš„äººç»§ç»­æ’é˜Ÿã€‚

åŒæ ·çš„ï¼Œåœ¨threadingæ¨¡å—ä¸­ï¼Œä¿¡å·é‡çš„æ“ä½œæœ‰ä¸¤ä¸ªå‡½æ•°ï¼Œå³ `acquire()` å’Œ `release()` ï¼Œè§£é‡Šå¦‚ä¸‹ï¼š

- æ¯å½“çº¿ç¨‹æƒ³è¦è¯»å–å…³è”äº†ä¿¡å·é‡çš„å…±äº«èµ„æºæ—¶ï¼Œå¿…é¡»è°ƒç”¨ `acquire()` ï¼Œæ­¤æ“ä½œå‡å°‘ä¿¡å·é‡çš„å†…éƒ¨å˜é‡, å¦‚æœæ­¤å˜é‡çš„å€¼éè´Ÿï¼Œé‚£ä¹ˆåˆ†é…è¯¥èµ„æºçš„æƒé™ã€‚å¦‚æœæ˜¯è´Ÿå€¼ï¼Œé‚£ä¹ˆçº¿ç¨‹è¢«æŒ‚èµ·ï¼Œç›´åˆ°æœ‰å…¶ä»–çš„çº¿ç¨‹é‡Šæ”¾èµ„æºã€‚
- å½“çº¿ç¨‹ä¸å†éœ€è¦è¯¥å…±äº«èµ„æºï¼Œå¿…é¡»é€šè¿‡ `release()` é‡Šæ”¾ã€‚è¿™æ ·ï¼Œä¿¡å·é‡çš„å†…éƒ¨å˜é‡å¢åŠ ï¼Œåœ¨ä¿¡å·é‡ç­‰å¾…é˜Ÿåˆ—ä¸­æ’åœ¨æœ€å‰é¢çš„çº¿ç¨‹ä¼šæ‹¿åˆ°å…±äº«èµ„æºçš„æƒé™ã€‚

![../_images/semaphores.png](https://python-parallel-programmning-cookbook.readthedocs.io/zh_CN/latest/_images/semaphores.png)

### 8.1 ä»£ç 

```python
import time
import threading


def run(n, se):
    se.acquire()
    print("run the thread: %s" % n)
    time.sleep(1)
    se.release()


# è®¾ç½®å…è®¸5ä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œ
semaphore = threading.BoundedSemaphore(5)
for i in range(20):
    t = threading.Thread(target=run, args=(i, semaphore))
    t.start()
```

è¿è¡Œç»“æœï¼š

â€‹	![BoundedSemaphore](https://typora-1300715298.cos.ap-shanghai.myqcloud.com/uPic/image-20210624101949016.png)

### 8.2 æ¶ˆè´¹è€…æ¨¡å‹çš„ä¿¡å·é‡ä½¿ç”¨

```python
# -*- coding: utf-8 -*-

"""Using a Semaphore to synchronize threads"""
import threading
import time
import random

# The optional argument gives the initial value for the internal
# counter;
# it defaults to 1.
# If the value given is less than 0, ValueError is raised.
semaphore = threading.Semaphore(0)

def consumer():
        print("consumer is waiting.")
        # Acquire a semaphore
        semaphore.acquire()
        # The consumer have access to the shared resource
        print("Consumer notify : consumed item number %s " % item)

def producer():
        global item
        time.sleep(10)
        # create a random item
        item = random.randint(0, 1000)
        print("producer notify : produced item number %s" % item)
         # Release a semaphore, incrementing the internal counter by one.
        # When it is zero on entry and another thread is waiting for it
        # to become larger than zero again, wake up that thread.
        semaphore.release()

if __name__ == '__main__':
        for i in range (0,5) :
                t1 = threading.Thread(target=producer)
                t2 = threading.Thread(target=consumer)
                t1.start()
                t2.start()
                t1.join()
                t2.join()
        print("program terminated")
```

æˆ‘ä»¬ä½¿ç”¨ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹å±•ç¤ºé€šè¿‡ä¿¡å·é‡çš„åŒæ­¥ã€‚å½“ç”Ÿäº§è€…ç”Ÿäº§å‡ºitemï¼Œä¾¿é‡Šæ”¾ä¿¡å·é‡ã€‚ç„¶åæ¶ˆè´¹è€…æ‹¿åˆ°èµ„æºè¿›è¡Œæ¶ˆè´¹ã€‚

è¿è¡Œç»“æœï¼š

```python
 â†µ  python -u thread_semaphore.py
consumer is waiting.
producer notify : produced item number 328
Consumer notify : consumed item number 328 
consumer is waiting.
producer notify : produced item number 230
Consumer notify : consumed item number 230 
consumer is waiting.
producer notify : produced item number 174
Consumer notify : consumed item number 174 
consumer is waiting.
producer notify : produced item number 573
Consumer notify : consumed item number 573 
consumer is waiting.
producer notify : produced item number 286
Consumer notify : consumed item number 286 
program terminated
```

## 9. æ¡ä»¶çº¿ç¨‹è®¾ç½®

æ¡ä»¶æŒ‡çš„æ˜¯åº”ç”¨ç¨‹åºçŠ¶æ€çš„æ”¹å˜ã€‚è¿™æ˜¯å¦ä¸€ç§åŒæ­¥æœºåˆ¶ï¼Œå…¶ä¸­æŸäº›çº¿ç¨‹åœ¨ç­‰å¾…æŸä¸€æ¡ä»¶å‘ç”Ÿï¼Œå…¶ä»–çš„çº¿ç¨‹ä¼šåœ¨è¯¥æ¡ä»¶å‘ç”Ÿçš„æ—¶å€™è¿›è¡Œé€šçŸ¥ã€‚ä¸€æ—¦æ¡ä»¶å‘ç”Ÿï¼Œçº¿ç¨‹ä¼šæ‹¿åˆ°å…±äº«èµ„æºçš„å”¯ä¸€æƒé™ã€‚

### 9.1 ä»£ç 

```python
from threading import Thread, Condition
import time

items = []
condition = Condition()

class consumer(Thread):

    def __init__(self):
        Thread.__init__(self)

    def consume(self):
        global condition
        global items
        condition.acquire()
        if len(items) == 0:
            condition.wait()
            print("Consumer notify : no item to consume")
        items.pop()
        print("Consumer notify : consumed 1 item")
        print("Consumer notify : items to consume are " + str(len(items)))

        condition.notify()
        condition.release()

    def run(self):
        for i in range(0, 20):
            time.sleep(2)
            self.consume()

class producer(Thread):

    def __init__(self):
        Thread.__init__(self)

    def produce(self):
        global condition
        global items
        condition.acquire()
        if len(items) == 10:
            condition.wait()
            print("Producer notify : items producted are " + str(len(items)))
            print("Producer notify : stop the production!!")
        items.append(1)
        print("Producer notify : total items producted " + str(len(items)))
        condition.notify()
        condition.release()

    def run(self):
        for i in range(0, 20):
            time.sleep(1)
            self.produce()

if __name__ == "__main__":
    producer = producer()
    consumer = consumer()
    producer.start()
    consumer.start()
    producer.join()
    consumer.join()
```

è¿è¡Œç»“æœï¼š

![../_images/Page-75-Image-12.png](https://python-parallel-programmning-cookbook.readthedocs.io/zh_CN/latest/_images/Page-75-Image-12.png)

(è¯‘è€…åœ¨è¿™é‡Œæ·»åŠ ä¸€æ®µã€‚ä¹ä¸€çœ‹è¿™æ®µä»£ç å¥½åƒä¼šæ­»é”ï¼Œå› ä¸º `condition.acquire()` ä¹‹åå°±åœ¨ `.wait()` äº†ï¼Œå¥½åƒä¼šä¸€ç›´æŒæœ‰é”ã€‚å…¶å® `.wait()` ä¼šå°†é”é‡Šæ”¾ï¼Œç„¶åç­‰å¾…å…¶ä»–çº¿ç¨‹ `.notify()` ä¹‹åä¼šé‡æ–°å°è¯•è·å¾—é”ã€‚ä½†æ˜¯è¦æ³¨æ„ `.notify()` å¹¶ä¸ä¼šè‡ªåŠ¨é‡Šæ”¾é”ï¼Œæ‰€ä»¥ä»£ç ä¸­æœ‰ä¸¤è¡Œï¼Œå…ˆ `.notify()` ç„¶åå† `.release()` ã€‚

è¯‘è€…ç”»äº†ä¸€å¼ å›¾ï¼Œæ–¹ä¾¿å¤§å®¶ç†è§£ã€‚è¿™é‡Œçš„è¿‡ç¨‹åº”è¯¥æ˜¯è¿™æ ·å­çš„ï¼ˆæ³¨æ„ `wait()` é‡Œé¢å®é™…æœ‰ä¸€ä¸ªé‡Šæ”¾é”é‡æ–°è·å¾—é”çš„è¿‡ç¨‹ï¼‰ï¼š

![../_images/python-condition.png](https://python-parallel-programmning-cookbook.readthedocs.io/zh_CN/latest/_images/python-condition.png)

è¯‘è€…çš„ç§è´§å®Œæ¯•ï¼Œå»ºè®®çœ‹ä¸€ä¸‹å®˜æ–¹æ–‡æ¡£ï¼š https://docs.python.org/3/library/threading.html )

æ¶ˆè´¹è€…é€šè¿‡æ‹¿åˆ°é”æ¥ä¿®æ”¹å…±äº«çš„èµ„æº `items[]` ï¼š

```
condition.acquire()
```

å¦‚æœlistçš„é•¿åº¦ä¸º0ï¼Œé‚£ä¹ˆæ¶ˆè´¹è€…å°±è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼š

```
if len(items) == 0:
    condition.wait()
```

å¦åˆ™å°±é€šè¿‡ `pop` æ“ä½œæ¶ˆè´¹ä¸€ä¸ªitemï¼š

```
items.pop()
```

ç„¶åï¼Œæ¶ˆè´¹è€…çš„çŠ¶æ€è¢«é€šçŸ¥ç»™ç”Ÿäº§è€…ï¼ŒåŒæ—¶å…±äº«èµ„æºé‡Šæ”¾ï¼š

```
condition.notify()
condition.release()
```

ç”Ÿäº§è€…æ‹¿åˆ°å…±äº«èµ„æºï¼Œç„¶åç¡®è®¤ç¼“å†²é˜Ÿåˆ—æ˜¯å¦å·²æ»¡ï¼ˆåœ¨æˆ‘ä»¬çš„è¿™ä¸ªä¾‹å­ä¸­ï¼Œæœ€å¤§å¯ä»¥å­˜æ”¾10ä¸ªitemï¼‰ï¼Œå¦‚æœå·²ç»æ»¡äº†ï¼Œé‚£ä¹ˆç”Ÿäº§è€…è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°è¢«å”¤é†’ï¼š

```
condition.acquire()
if len(items) == 10:
    condition.wait()
```

å¦‚æœé˜Ÿåˆ—æ²¡æœ‰æ»¡ï¼Œå°±ç”Ÿäº§1ä¸ªitemï¼Œé€šçŸ¥çŠ¶æ€å¹¶é‡Šæ”¾èµ„æºï¼š

```
condition.notify()
condition.release()
```

## 10. äº‹ä»¶è¿›è¡Œçº¿ç¨‹åŒæ­¥

äº‹ä»¶æ˜¯çº¿ç¨‹ä¹‹é—´ç”¨äºé€šè®¯çš„å¯¹è±¡ã€‚æœ‰çš„çº¿ç¨‹ç­‰å¾…ä¿¡å·ï¼Œæœ‰çš„çº¿ç¨‹å‘å‡ºä¿¡å·ã€‚åŸºæœ¬ä¸Šäº‹ä»¶å¯¹è±¡éƒ½ä¼šç»´æŠ¤ä¸€ä¸ªå†…éƒ¨å˜é‡ï¼Œå¯ä»¥é€šè¿‡ `set()` æ–¹æ³•è®¾ç½®ä¸º `true` ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ `clear()` æ–¹æ³•è®¾ç½®ä¸º `false` ã€‚ `wait()` æ–¹æ³•å°†ä¼šé˜»å¡çº¿ç¨‹ï¼Œç›´åˆ°å†…éƒ¨å˜é‡ä¸º `true` ã€‚

### 10.1 ä»£ç 

```python
import time
from threading import Thread, Event
import random
items = []
event = Event()

class consumer(Thread):
    def __init__(self, items, event):
        Thread.__init__(self)
        self.items = items
        self.event = event

    def run(self):
        while True:
            time.sleep(2)
            self.event.wait()
            item = self.items.pop()
            print('Consumer notify : %d popped from list by %s' % (item, self.name))

class producer(Thread):
    def __init__(self, items, event):
        Thread.__init__(self)
        self.items = items
        self.event = event

    def run(self):
        global item
        for i in range(100):
            time.sleep(2)
            item = random.randint(0, 256)
            self.items.append(item)
            print('Producer notify : item NÂ° %d appended to list by %s' % (item, self.name))
            print('Producer notify : event set by %s' % self.name)
            self.event.set()
            print('Produce notify : event cleared by %s '% self.name)
            self.event.clear()

if __name__ == '__main__':
    t1 = producer(items, event)
    t2 = consumer(items, event)
    t1.start()
    t2.start()
    t1.join()
    t2.join()

```

çº¿ç¨‹t1åœ¨listæœ€åæ·»åŠ å€¼ï¼Œç„¶åè®¾ç½®eventæ¥é€šçŸ¥æ¶ˆè´¹è€…ã€‚æ¶ˆè´¹è€…é€šè¿‡ `wait()` é˜»å¡ï¼Œç›´åˆ°æ”¶åˆ°ä¿¡å·çš„æ—¶å€™ä»listä¸­å–å‡ºå…ƒç´ æ¶ˆè´¹ã€‚

è¿è¡Œç»“æœï¼š

![../_images/Page-78-Image-13.png](https://python-parallel-programmning-cookbook.readthedocs.io/zh_CN/latest/_images/Page-78-Image-13.png)

è§£é‡Šï¼š

`producer` ç±»åˆå§‹åŒ–æ—¶å®šä¹‰äº†itemçš„listå’Œ `Event` ï¼Œä¸æ¡ä»¶å¯¹è±¡æ—¶å€™çš„ä¾‹å­ä¸åŒï¼Œè¿™é‡Œçš„listå¹¶ä¸æ˜¯å…¨å±€çš„ï¼Œè€Œæ˜¯é€šè¿‡å‚æ•°ä¼ å…¥çš„ï¼š

```
class consumer(Thread):
    def __init__(self, items, event):
        Thread.__init__(self)
        self.items = items
        self.event = event
```

åœ¨runæ–¹æ³•ä¸­ï¼Œæ¯å½“itemåˆ›å»ºï¼Œ `producer` ç±»å°†æ–°itemæ·»åŠ åˆ°listæœ«å°¾ç„¶åå‘å‡ºäº‹ä»¶é€šçŸ¥ã€‚ä½¿ç”¨äº‹ä»¶æœ‰ä¸¤æ­¥ï¼Œç¬¬ä¸€æ­¥ï¼š

```
self.event.set()
```

ç¬¬äºŒæ­¥ï¼š

```
self.event.clear()
```

`consumer` ç±»åˆå§‹åŒ–æ—¶ä¹Ÿå®šä¹‰äº†itemçš„listå’Œ `Event()` ã€‚å½“itemè¿›æ¥çš„æ—¶å€™ï¼Œå®ƒå°†å…¶å–å‡ºï¼š

```
def run(self):
    while True:
        time.sleep(2)
        self.event.wait()
        item = self.items.pop()
        print('Consumer notify : %d popped from list by %s' % (item, self.name))
```

ä¸‹å›¾å¯ä»¥å¸®æˆ‘ä»¬è®¤è¯† `producer` å’Œ `consumer` ï¼š

![../_images/event.png](https://python-parallel-programmning-cookbook.readthedocs.io/zh_CN/latest/_images/event.png)

## 11. çº¿ç¨‹ä¸­çš„withè¯­å¥

Pythonä»2.5ç‰ˆæœ¬å¼€å§‹å¼•å…¥äº† `with` è¯­æ³•ã€‚æ­¤è¯­æ³•éå¸¸å®ç”¨ï¼Œåœ¨æœ‰ä¸¤ä¸ªç›¸å…³çš„æ“ä½œéœ€è¦åœ¨ä¸€éƒ¨åˆ†ä»£ç å—å‰ååˆ†åˆ«æ‰§è¡Œçš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨ `with` è¯­æ³•è‡ªåŠ¨å®Œæˆã€‚åŒäº‹ï¼Œä½¿ç”¨ `with` è¯­æ³•å¯ä»¥åœ¨ç‰¹å®šçš„åœ°æ–¹åˆ†é…å’Œé‡Šæ”¾èµ„æºï¼Œå› æ­¤ï¼Œ `with` è¯­æ³•ä¹Ÿå«åšâ€œä¸Šä¸‹æ–‡ç®¡ç†å™¨â€ã€‚åœ¨threadingæ¨¡å—ä¸­ï¼Œæ‰€æœ‰å¸¦æœ‰ `acquire()` æ–¹æ³•å’Œ `release()` æ–¹æ³•çš„å¯¹è±¡éƒ½å¯ä»¥ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸‹é¢çš„å¯¹è±¡å¯ä»¥ä½¿ç”¨ `with` è¯­æ³•ï¼š

- Lock
- RLock
- Condition
- Semaphore

### 11.1 ä»£ç 

```python
import threading
import logging
logging.basicConfig(level=logging.DEBUG, format='(%(threadName)-10s) %(message)s',)

def threading_with(statement):
    with statement:
        logging.debug('%s acquired via with' % statement)

def threading_not_with(statement):
    statement.acquire()
    try:
        logging.debug('%s acquired directly' % statement )
    finally:
        statement.release()

if __name__ == '__main__':
    # let's create a test battery
    lock = threading.Lock()
    rlock = threading.RLock()
    condition = threading.Condition()
    mutex = threading.Semaphore(1)
    threading_synchronization_list = [lock, rlock, condition, mutex]
    # in the for cycle we call the threading_with e threading_no_with function
    for statement in threading_synchronization_list :
       t1 = threading.Thread(target=threading_with, args=(statement,))
       t2 = threading.Thread(target=threading_not_with, args=(statement,))
       t1.start()
       t2.start()
       t1.join()
       t2.join()
```

è¿è¡Œç»“æœ:

```python
â†µ python -u thread_with.py
(Thread-1  ) <locked _thread.lock object at 0x1019a1450> acquired via with
(Thread-2  ) <locked _thread.lock object at 0x1019a1450> acquired directly
(Thread-3  ) <locked _thread.RLock object owner=123145583611904 count=1 at 0x1019a1420> acquired via with
(Thread-4  ) <locked _thread.RLock object owner=123145583611904 count=1 at 0x1019a1420> acquired directly
(Thread-5  ) <Condition(<locked _thread.RLock object owner=123145583611904 count=1 at 0x1019a19c0>, 0)> acquired via with
(Thread-6  ) <Condition(<locked _thread.RLock object owner=123145600401408 count=1 at 0x1019a19c0>, 0)> acquired directly
(Thread-7  ) <threading.Semaphore object at 0x101818910> acquired via with
(Thread-8  ) <threading.Semaphore object at 0x101818910> acquired directly
```

### 10.2 è§£é‡Š

åœ¨ä¸»ç¨‹åºä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªlistï¼Œ `threading_synchronization_list` ï¼ŒåŒ…å«è¦æµ‹è¯•çš„çº¿ç¨‹åŒæ­¥ä½¿ç”¨çš„å¯¹è±¡ï¼š

```
lock = threading.Lock()
rlock = threading.RLock()
condition = threading.Condition()
mutex = threading.Semaphore(1)
threading_synchronization_list = [lock, rlock, condition, mutex]
```

å®šä¹‰ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ `for` å¾ªç¯ä¸­æµ‹è¯•æ¯ä¸€ä¸ªå¯¹è±¡ï¼š

```
for statement in threading_synchronization_list :
   t1 = threading.Thread(target=threading_with, args=(statement,))
   t2 = threading.Thread(target=threading_not_with, args=(statement,))
```

æœ€åï¼Œæˆ‘ä»¬æœ‰ä¸¤ä¸ªç›®æ ‡å‡½æ•°ï¼Œå…¶ä¸­ `threading_with` æµ‹è¯•äº† `with` è¯­æ³•ï¼š

```
def threading_with(statement):
    with statement:
        logging.debug('%s acquired via with' % statement)
```

## 12. ä½¿ç”¨é˜Ÿåˆ—è¿›è¡Œçº¿ç¨‹é€šä¿¡

å½“çº¿ç¨‹ä¹‹é—´å¦‚æœè¦å…±äº«èµ„æºæˆ–æ•°æ®çš„æ—¶å€™ï¼Œå¯èƒ½å˜çš„éå¸¸å¤æ‚ã€‚å¦‚ä½ æ‰€è§ï¼ŒPythonçš„threadingæ¨¡å—æä¾›äº†å¾ˆå¤šåŒæ­¥åŸè¯­ï¼ŒåŒ…æ‹¬ä¿¡å·é‡ï¼Œæ¡ä»¶å˜é‡ï¼Œäº‹ä»¶å’Œé”ã€‚å¦‚æœå¯ä»¥ä½¿ç”¨è¿™äº›åŸè¯­çš„è¯ï¼Œåº”è¯¥ä¼˜å…ˆè€ƒè™‘ä½¿ç”¨è¿™äº›ï¼Œè€Œä¸æ˜¯ä½¿ç”¨queueï¼ˆé˜Ÿåˆ—ï¼‰æ¨¡å—ã€‚é˜Ÿåˆ—æ“ä½œèµ·æ¥æ›´å®¹æ˜“ï¼Œä¹Ÿä½¿å¤šçº¿ç¨‹ç¼–ç¨‹æ›´å®‰å…¨ï¼Œå› ä¸ºé˜Ÿåˆ—å¯ä»¥å°†èµ„æºçš„ä½¿ç”¨é€šè¿‡å•çº¿ç¨‹è¿›è¡Œå®Œå…¨æ§åˆ¶ï¼Œå¹¶ä¸”å…è®¸ä½¿ç”¨æ›´åŠ æ•´æ´å’Œå¯è¯»æ€§æ›´é«˜çš„è®¾è®¡æ¨¡å¼ã€‚

Queueå¸¸ç”¨çš„æ–¹æ³•æœ‰ä»¥ä¸‹å››ä¸ªï¼š

- `put()`: å¾€queueä¸­æ”¾ä¸€ä¸ªitem
- `get()`: ä»queueåˆ é™¤ä¸€ä¸ªitemï¼Œå¹¶è¿”å›åˆ é™¤çš„è¿™ä¸ªitem
- `task_done()`: æ¯æ¬¡itemè¢«å¤„ç†çš„æ—¶å€™éœ€è¦è°ƒç”¨è¿™ä¸ªæ–¹æ³•
- `join()`: æ‰€æœ‰iteméƒ½è¢«å¤„ç†ä¹‹å‰ä¸€ç›´é˜»å¡

### 12.2 ä»£ç 

```python
from threading import Thread, Event
from queue import Queue
import time
import random
class producer(Thread):
    def __init__(self, queue):
        Thread.__init__(self)
        self.queue = queue

    def run(self) :
        for i in range(10):
            item = random.randint(0, 256)
            self.queue.put(item)
            print('Producer notify: item NÂ° %d appended to queue by %s' % (item, self.name))
            time.sleep(1)

class consumer(Thread):
    def __init__(self, queue):
        Thread.__init__(self)
        self.queue = queue

    def run(self):
        while True:
            item = self.queue.get()
            print('Consumer notify : %d popped from queue by %s' % (item, self.name))
            self.queue.task_done()

if __name__ == '__main__':
    queue = Queue()
    t1 = producer(queue)
    t2 = consumer(queue)
    t3 = consumer(queue)
    t4 = consumer(queue)
    t1.start()
    t2.start()
    t3.start()
    t4.start()
    t1.join()
    t2.join()
    t3.join()
    t4.join()
```

è¿è¡Œç»“æœï¼š

![../_images/Page-85-Image-15.png](https://python-parallel-programmning-cookbook.readthedocs.io/zh_CN/latest/_images/Page-85-Image-15.png)

### 12.2 è§£é‡Š

é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç”Ÿäº§è€…ç±»ã€‚ç”±äºæˆ‘ä»¬ä½¿ç”¨é˜Ÿåˆ—å­˜æ”¾æ•°å­—ï¼Œæ‰€ä»¥ä¸éœ€è¦ç”¨æ¥å­˜æ”¾æ•°å­—çš„listäº†ã€‚

```
class producer(Thread):
    def __init__(self, queue):
        Thread.__init__(self)
        self.queue = queue
```

`producer` ç±»ç”Ÿäº§æ•´æ•°ï¼Œç„¶åé€šè¿‡ä¸€ä¸ª `for` å¾ªç¯å°†æ•´æ•°æ”¾åˆ°é˜Ÿåˆ—ä¸­ï¼š

```
def run(self) :
    for i in range(10):
        item = random.randint(0, 256)
        self.queue.put(item)
        print('Producer notify: item NÂ° %d appended to queue by %s' % (item, self.name))
        time.sleep(1)
```

ç”Ÿäº§è€…ä½¿ç”¨ `Queue.put(item [,block[, timeout]])` æ¥å¾€queueä¸­æ’å…¥æ•°æ®ã€‚Queueæ˜¯åŒæ­¥çš„ï¼Œåœ¨æ’å…¥æ•°æ®ä¹‹å‰å†…éƒ¨æœ‰ä¸€ä¸ªå†…ç½®çš„é”æœºåˆ¶ã€‚

å¯èƒ½å‘ç”Ÿä¸¤ç§æƒ…å†µï¼š

- å¦‚æœ `block` ä¸º `True` ï¼Œ `timeout` ä¸º `None` ï¼ˆè¿™ä¹Ÿæ˜¯é»˜è®¤çš„é€‰é¡¹ï¼Œæœ¬ä¾‹ä¸­ä½¿ç”¨é»˜è®¤é€‰é¡¹ï¼‰ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šé˜»å¡æ‰ï¼Œç›´åˆ°å‡ºç°å¯ç”¨çš„ä½ç½®ã€‚å¦‚æœ `timeout` æ˜¯æ­£æ•´æ•°ï¼Œé‚£ä¹ˆé˜»å¡ç›´åˆ°è¿™ä¸ªæ—¶é—´ï¼Œå°±ä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ã€‚
- å¦‚æœ `block` ä¸º `False` ï¼Œå¦‚æœé˜Ÿåˆ—æœ‰é—²ç½®é‚£ä¹ˆä¼šç«‹å³æ’å…¥ï¼Œå¦åˆ™å°±ç«‹å³æŠ›å‡ºå¼‚å¸¸ï¼ˆ `timeout` å°†ä¼šè¢«å¿½ç•¥ï¼‰ã€‚æœ¬ä¾‹ä¸­ï¼Œ `put()` æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦å·²æ»¡ï¼Œç„¶åè°ƒç”¨ `wait()` å¼€å§‹ç­‰å¾…ã€‚

æ¶ˆè´¹è€…ä»é˜Ÿåˆ—ä¸­å–å‡ºæ•´æ•°ç„¶åç”¨ `task_done()` æ–¹æ³•å°†å…¶æ ‡ä¸ºä»»åŠ¡å·²å¤„ç†ã€‚

æ¶ˆè´¹è€…ä½¿ç”¨ `Queue.get([block[, timeout]])` ä»é˜Ÿåˆ—ä¸­å–å›æ•°æ®ï¼Œqueueå†…éƒ¨ä¹Ÿä¼šç»è¿‡é”çš„å¤„ç†ã€‚å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œæ¶ˆè´¹è€…é˜»å¡ã€‚

æœ€åï¼Œåœ¨ä¸»ç¨‹åºä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºçº¿ç¨‹tä½œä¸ºç”Ÿäº§è€…ï¼Œt1, t2, t3ä½œä¸ºæ¶ˆè´¹è€…ï¼š

```
if __name__ == '__main__':
    queue = Queue()
    t1 = producer(queue)
    t2 = consumer(queue)
    t3 = consumer(queue)
    t4 = consumer(queue)
    t1.start()
    t2.start()
    t3.start()
    t4.start()
    t1.join()
    t2.join()
    t3.join()
    t4.join()
```

ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´çš„æ“ä½œå¯ä»¥ç”¨ä¸‹å›¾æ¥æè¿°ï¼š

![../_images/queue.png](https://python-parallel-programmning-cookbook.readthedocs.io/zh_CN/latest/_images/queue.png)

## 13. è¯„ä¼°å¤šçº¿ç¨‹åº”ç”¨çš„æ€§èƒ½

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†éªŒè¯GILçš„å½±å“ï¼Œè¯„ä¼°å¤šçº¿ç¨‹åº”ç”¨çš„æ€§èƒ½ã€‚å‰æ–‡å·²ç»ä»‹ç»è¿‡ï¼ŒGILæ˜¯CPythonè§£é‡Šå™¨å¼•å…¥çš„é”ï¼ŒGILåœ¨è§£é‡Šå™¨å±‚é¢é˜»æ­¢äº†çœŸæ­£çš„å¹¶è¡Œè¿è¡Œã€‚è§£é‡Šå™¨åœ¨æ‰§è¡Œä»»ä½•çº¿ç¨‹ä¹‹å‰ï¼Œå¿…é¡»ç­‰å¾…å½“å‰æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹é‡Šæ”¾GILã€‚äº‹å®ä¸Šï¼Œè§£é‡Šå™¨ä¼šå¼ºè¿«æƒ³è¦è¿è¡Œçš„çº¿ç¨‹å¿…é¡»æ‹¿åˆ°GILæ‰èƒ½è®¿é—®è§£é‡Šå™¨çš„ä»»ä½•èµ„æºï¼Œä¾‹å¦‚æ ˆæˆ–Pythonå¯¹è±¡ç­‰ã€‚è¿™ä¹Ÿæ­£æ˜¯GILçš„ç›®çš„â€”â€”é˜»æ­¢ä¸åŒçš„çº¿ç¨‹å¹¶å‘è®¿é—®Pythonå¯¹è±¡ã€‚è¿™æ ·GILå¯ä»¥ä¿æŠ¤è§£é‡Šå™¨çš„å†…å­˜ï¼Œè®©åƒåœ¾å›æ”¶å·¥ä½œæ­£å¸¸ã€‚ä½†äº‹å®ä¸Šï¼Œè¿™å´é€ æˆäº†ç¨‹åºå‘˜æ— æ³•é€šè¿‡å¹¶è¡Œæ‰§è¡Œå¤šçº¿ç¨‹æ¥æé«˜ç¨‹åºçš„æ€§èƒ½ã€‚å¦‚æœæˆ‘ä»¬å»æ‰CPythonçš„GILï¼Œå°±å¯ä»¥è®©å¤šçº¿ç¨‹çœŸæ­£å¹¶è¡Œæ‰§è¡Œã€‚GILå¹¶æ²¡æœ‰å½±å“å¤šå¤„ç†å™¨å¹¶è¡Œçš„çº¿ç¨‹ï¼Œåªæ˜¯é™åˆ¶äº†ä¸€ä¸ªè§£é‡Šå™¨åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è¿è¡Œã€‚

### 13.1 ä»£ç 

ä¸‹é¢çš„ä»£ç æ˜¯ç”¨æ¥è¯„ä¼°å¤šçº¿ç¨‹åº”ç”¨æ€§èƒ½çš„ç®€å•å·¥å…·ã€‚ä¸‹é¢çš„æ¯ä¸€ä¸ªæµ‹è¯•éƒ½å¾ªç¯è°ƒç”¨å‡½æ•°100æ¬¡ï¼Œé‡å¤æ‰§è¡Œå¤šæ¬¡ï¼Œå–é€Ÿåº¦æœ€å¿«çš„ä¸€æ¬¡ã€‚åœ¨ `for` å¾ªç¯ä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨ `non_threaded` å’Œ `threaded` å‡½æ•°ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¼šä¸æ–­å¢åŠ è°ƒç”¨æ¬¡æ•°å’Œçº¿ç¨‹æ•°æ¥é‡å¤æ‰§è¡Œè¿™ä¸ªæµ‹è¯•ã€‚æˆ‘ä»¬ä¼šå°è¯•ä½¿ç”¨1ï¼Œ2ï¼Œ3ï¼Œ4å’Œ8çº¿ç¨‹æ•°æ¥è°ƒç”¨çº¿ç¨‹ã€‚åœ¨éçº¿ç¨‹çš„æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬é¡ºåºè°ƒç”¨å‡½æ•°ä¸å¯¹åº”çº¿ç¨‹æ•°ä¸€æ ·å¤šçš„æ¬¡æ•°ã€‚ä¸ºäº†ä¿æŒç®€å•ï¼Œåº¦é‡çš„æŒ‡æ ‡ä½¿ç”¨Pythonçš„å†…å»ºæ¨¡å—timerã€‚

ä»£ç å¦‚ä¸‹ï¼š

```python
from threading import Thread

class threads_object(Thread):
    def run(self):
        function_to_run()

class nothreads_object(object):
    def run(self):
        function_to_run()

def non_threaded(num_iter):
    funcs = []
    for i in range(int(num_iter)):
        funcs.append(nothreads_object())
    for i in funcs:
        i.run()

def threaded(num_threads):
    funcs = []
    for i in range(int(num_threads)):
        funcs.append(threads_object())
    for i in funcs:
        i.start()
    for i in funcs:
        i.join()

def function_to_run():
    pass

def show_results(func_name, results):
    print("%-23s %4.6f seconds" % (func_name, results))

if __name__ == "__main__":
    import sys
    from timeit import Timer
    repeat = 100
    number = 1
    num_threads = [1, 2, 4, 8]
    print('Starting tests')
    for i in num_threads:
        t = Timer("non_threaded(%s)" % i, "from __main__ import non_threaded")
        best_result = min(t.repeat(repeat=repeat, number=number))
        show_results("non_threaded (%s iters)" % i, best_result)
        t = Timer("threaded(%s)" % i, "from __main__ import threaded")
        best_result = min(t.repeat(repeat=repeat, number=number))
        show_results("threaded (%s threads)" % i, best_result)
        print('Iterations complete')
```

## 13.2. è§£é‡Š

æˆ‘ä»¬ä¸€å…±è¿›è¡Œäº†å››æ¬¡æµ‹è¯•(è¯‘è€…æ³¨ï¼šåŸæ–‡æ˜¯threeï¼Œæˆ‘æ€€ç–‘åŸä½œè€…ä¸è¯†æ•°ï¼ŒåŸæ–‡çš„3ä¸ªçº¿ç¨‹æ•°ä¹Ÿæ²¡æœ‰å†™åœ¨ä»£ç é‡Œï¼‰ï¼Œæ¯ä¸€æ¬¡éƒ½ä¼šä½¿ç”¨ä¸åŒçš„functionè¿›è¡Œæµ‹è¯•ï¼Œåªè¦æ”¹å˜ `function_to_run()` å°±å¯ä»¥äº†ã€‚

æµ‹è¯•ç”¨çš„æœºå™¨æ˜¯ Core 2 Duo CPU â€“ 2.33Ghzã€‚

### ç¬¬ä¸€æ¬¡æµ‹è¯•

åœ¨ç¬¬ä¸€æ¬¡æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªç®€å•çš„ç©ºå‡½æ•°ï¼š

```
def function_to_run():
    pass
```

ä¸‹å›¾å±•ç¤ºäº†æˆ‘ä»¬æµ‹è¯•çš„æ¯ä¸ªæœºåˆ¶çš„è¿è¡Œé€Ÿåº¦ï¼š

![test1](https://typora-1300715298.cos.ap-shanghai.myqcloud.com/uPic/image-20210624105756890.png)

é€šè¿‡ç»“æœå¯ä»¥å‘ç°ï¼Œä½¿ç”¨çº¿ç¨‹çš„å¼€é”€è¦æ¯”ä¸ä½¿ç”¨çº¿ç¨‹çš„å¼€é”€å¤§çš„å¤šã€‚ç‰¹åˆ«çš„ï¼Œæˆ‘ä»¬å‘ç°éšç€çº¿ç¨‹çš„æ•°é‡å¢åŠ ï¼Œå¸¦æ¥çš„å¼€é”€æ˜¯æˆæ¯”ä¾‹çš„ã€‚4ä¸ªçº¿ç¨‹çš„è¿è¡Œæ—¶é—´æ˜¯0.000162ç§’ï¼Œ8ä¸ªçº¿ç¨‹çš„è¿è¡Œæ—¶é—´æ˜¯0.000316ç§’ã€‚

### ç¬¬äºŒæ¬¡æµ‹è¯•

å¤šçº¿ç¨‹æ¯”è¾ƒå¸¸ç”¨çš„ä¸€ä¸ªç”¨é€”æ˜¯å¤„ç†æ•°å­—ï¼Œä¸‹é¢çš„æµ‹è¯•è®¡ç®—æ–æ³¢é‚£å¥‘æ•°åˆ—ï¼Œæ³¨æ„è¿™ä¸ªä¾‹å­ä¸­æ²¡æœ‰å…±äº«çš„èµ„æºï¼Œåªæ˜¯æµ‹è¯•ç”Ÿæˆæ•°å­—æ•°åˆ—ï¼š

```
def function_to_run():
    a, b = 0, 1
    for i in range(10000):
        a, b = b, a + b
```

è¾“å‡ºå¦‚ä¸‹ï¼š

![image-20210624105829147](https://typora-1300715298.cos.ap-shanghai.myqcloud.com/uPic/image-20210624105829147.png)

åœ¨è¾“å‡ºä¸­å¯ä»¥çœ‹åˆ°ï¼Œæé«˜çº¿ç¨‹çš„æ•°é‡å¹¶æ²¡æœ‰å¸¦æ¥æ”¶ç›Šã€‚å› ä¸ºGILå’Œçº¿ç¨‹ç®¡ç†ä»£ç çš„å¼€é”€ï¼Œå¤šçº¿ç¨‹è¿è¡Œæ°¸è¿œä¸å¯èƒ½æ¯”å‡½æ•°é¡ºåºæ‰§è¡Œæ›´å¿«ã€‚å†æ¬¡æé†’ä¸€ä¸‹ï¼šGILåªå…è®¸è§£é‡Šå™¨ä¸€æ¬¡æ‰§è¡Œä¸€ä¸ªçº¿ç¨‹ã€‚

### ç¬¬ä¸‰æ¬¡æµ‹è¯•

ä¸‹é¢çš„æµ‹è¯•æ˜¯è¯»1kbçš„æ•°æ®1000æ¬¡ï¼Œæµ‹è¯•ç”¨çš„å‡½æ•°å¦‚ä¸‹ï¼š

```
def function_to_run():
    fh=open("C:\\CookBookFileExamples\\test.dat","rb")
    size = 1024
    for i in range(1000):
        fh.read(size)
```

æµ‹è¯•çš„ç»“æœå¦‚ä¸‹ï¼š

![../_images/Page-92-Image-18.png](https://python-parallel-programmning-cookbook.readthedocs.io/zh_CN/latest/_images/Page-92-Image-18.png)

æˆ‘ä»¬ç»ˆäºçœ‹åˆ°å¤šçº¿ç¨‹æ¯”éå¤šçº¿ç¨‹è·‘çš„å¥½çš„æƒ…å†µäº†ï¼Œè€Œä¸”å¤šçº¿ç¨‹åªç”¨äº†ä¸€åŠçš„æ—¶é—´ã€‚è¿™ç»™æˆ‘ä»¬çš„å¯ç¤ºæ˜¯ï¼Œå¤šçº¿ç¨‹å¹¶ä¸æ˜¯ä¸€ä¸ªæ ‡å‡†ã€‚ä¸€èˆ¬ï¼Œæˆ‘ä»¬å°†ä¼šå°†å¤šçº¿ç¨‹æ”¾å…¥ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œå°†å®ƒä»¬æ”¾åˆ°ä¸€è¾¹ï¼Œæ‰§è¡Œå…¶ä»–ä»»åŠ¡ã€‚ä½¿ç”¨å¤šçº¿ç¨‹æ‰§è¡ŒåŒä¸€ä¸ªç›¸åŒçš„ä»»åŠ¡æœ‰æ—¶å€™å¾ˆæœ‰ç”¨ï¼Œä½†ç”¨åˆ°çš„æ—¶å€™å¾ˆå°‘ï¼Œé™¤ééœ€è¦å¤§é‡å¤„ç†æ•°æ®è¾“å…¥ã€‚

### ç¬¬å››æ¬¡æµ‹è¯•

åœ¨æœ€åçš„æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ `urllib.request` æµ‹è¯•ï¼Œè¿™æ˜¯ä¸€ä¸ªPythonæ¨¡å—ï¼Œå¯ä»¥å‘é€URLè¯·æ±‚ã€‚æ­¤æ¨¡å—åŸºäº `socket` ï¼Œä½¿ç”¨Cè¯­è¨€ç¼–å†™å¹¶ä¸”æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

ä¸‹é¢çš„ä»£ç å°è¯•è¯»å– `https://www.packpub.com` çš„ä¸»é¡µå¹¶ä¸”è¯»å–å‰1kçš„æ•°æ®ï¼š

```
def function_to_run():
    import urllib.request
    for i in range(10):
        with urllib.request.urlopen("https://www.packtpub.com/")as f:
            f.read(1024)
```

è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

![../_images/Page-93-Image-19.png](https://python-parallel-programmning-cookbook.readthedocs.io/zh_CN/latest/_images/Page-93-Image-19.png)

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ I/O æœŸé—´ï¼ŒGILé‡Šæ”¾äº†ã€‚å¤šçº¿ç¨‹æ‰§è¡Œæ¯”å•çº¿ç¨‹å¿«çš„å¤šã€‚é‰´äºå¤§å¤šæ•°åº”ç”¨éœ€è¦å¾ˆå¤šI/Oæ“ä½œï¼ŒGILå¹¶æ²¡æœ‰é™åˆ¶ç¨‹åºå‘˜åœ¨è¿™æ–¹é¢ä½¿ç”¨å¤šçº¿ç¨‹å¯¹ç¨‹åºè¿›è¡Œæ€§èƒ½ä¼˜åŒ–ã€‚

## 13.3. äº†è§£æ›´å¤š

ä½ åº”è¯¥è®°ä½ï¼Œå¢åŠ çº¿ç¨‹å¹¶ä¸ä¼šæé«˜åº”ç”¨å¯åŠ¨çš„æ—¶é—´ï¼Œä½†æ˜¯å¯ä»¥æ”¯æŒå¹¶å‘ã€‚ä¾‹å¦‚ï¼Œä¸€æ¬¡æ€§åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼Œå¹¶é‡ç”¨workerä¼šå¾ˆæœ‰ç”¨ã€‚è¿™å¯ä»¥è®©æˆ‘ä»¬åˆ‡åˆ†ä¸€ä¸ªå¤§çš„æ•°æ®é›†ï¼Œç”¨åŒæ ·çš„å‡½æ•°å¤„ç†ä¸åŒçš„éƒ¨åˆ†ï¼ˆç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ï¼‰ã€‚ä¸Šé¢è¿™äº›æµ‹è¯•å¹¶ä¸æ˜¯å¹¶å‘åº”ç”¨çš„æ¨¡å‹ï¼Œåªæ˜¯å°½é‡ç®€å•çš„æµ‹è¯•ã€‚é‚£ä¹ˆGILä¼šæˆä¸ºè¯•å›¾å‘æŒ¥å¤šçº¿ç¨‹åº”ç”¨æ½œèƒ½çš„çº¯Pythonå¼€å‘çš„ç“¶é¢ˆå—ï¼Ÿæ˜¯çš„ã€‚çº¿ç¨‹æ˜¯ç¼–ç¨‹è¯­è¨€çš„æ¶æ„ï¼ŒCPythonè§£é‡Šå™¨æ˜¯çº¿ç¨‹å’Œæ“ä½œç³»ç»Ÿçš„æ¡¥æ¢ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆJythonï¼ŒIronPythonæ²¡æœ‰GILçš„åŸå› ï¼ˆè¯‘è€…æ³¨ï¼šPypyä¹Ÿæ²¡æœ‰ï¼‰ï¼Œå› ä¸ºå®ƒä¸æ˜¯å¿…è¦çš„ã€‚

